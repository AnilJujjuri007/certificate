import tkinter as tk
from tkinter import filedialog
from opcua import Client
from opcua import ua

# Specify the OPC UA server endpoint
opcua_endpoint = "opc.tcp://BLRTSL00330.lnties.com:53530/OPCUA/SimulationServer"

# Function to determine the type of a node and retrieve its value
def get_node_type_and_value(client,node):
    if node.get_node_class() == ua.NodeClass.Object:
        children = node.get_children()
        print(f"{node.get_browse_name()} is an object having following child nodes:")
        for child in children:
            get_node_type_and_value(client,child)
        client.disconnect()
    elif node.get_node_class() == ua.NodeClass.Variable:
        value = node.get_value()
        if value is not None:
            print(f"Node Name: {node.get_browse_name().Name}, NodeId: {node.nodeid}, Value: {value}")
        else:
            print(f"Node Name: {node.get_browse_name().Name}, NodeId: {node.nodeid}")

# Function to upload and process a CSV file
def upload_and_process_csv():
    file_path = filedialog.askopenfilename(filetypes=[("CSV Files", "*.csv")])
    if file_path:
        try:
            with open(file_path, 'r') as csvfile:
                for row in csvfile:
                    node_info = row.strip().split(',')
                    if len(node_info) == 2:
                        node_id, connection_address = node_info
                        try:
                            with Client(connection_address) as client:
                                client.connect()
                                node = client.get_node(node_id)
                                get_node_type_and_value(client,node)
                                
                        except Exception as e:
                            print(f"Error reading node {node_id} from {connection_address}: {str(e)}")
                            client.disconnect()
        except Exception as e:
            print(f"Error processing CSV file: {str(e)}")

# Create a Tkinter window
window = tk.Tk()
window.title("CSV File Upload and OPC UA Processing")

# Create a button to trigger the file upload and processing
upload_button = tk.Button(window, text="Upload CSV File and Process", command=upload_and_process_csv)
upload_button.pack()

# Start the Tkinter main loop
window.mainloop()